name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  OMP_NUM_THREADS: 1
  ENABLE_GPU: "false"

jobs:
  test-hybrid:
    name: Test (Py${{ matrix.python-version }} | ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, macos-13, windows-2022]
        python-version: ["3.10", "3.11"]

    steps:
      # ─────────────────────────────
      # Checkout
      # ─────────────────────────────
      - name: Checkout code
        uses: actions/checkout@v4

      # ─────────────────────────────
      # Python
      # ─────────────────────────────
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      # ─────────────────────────────
      # Rust Cache (cross-platform safe)
      # ─────────────────────────────
      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      # ─────────────────────────────
      # Pip Cache
      # ─────────────────────────────
      - name: Cache Pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # ─────────────────────────────
      # System Dependencies
      # ─────────────────────────────
      - name: Linux deps
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential libomp-dev

      - name: macOS deps
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install cmake libomp

      - name: Windows deps
        if: runner.os == 'Windows'
        run: |
          choco install cmake -y

      # ─────────────────────────────
      # Python Tooling
      # ─────────────────────────────
      - name: Install Python build tools
        run: |
          python -m pip install --upgrade pip
          pip install pytest

      # ─────────────────────────────
      # PyTorch (CPU-only, OS-safe)
      # ─────────────────────────────
      - name: Install PyTorch (Linux)
        if: runner.os == 'Linux'
        run: |
          pip install torch --index-url https://download.pytorch.org/whl/cpu

      - name: Install PyTorch (macOS)
        if: runner.os == 'macOS'
        run: |
          pip install torch

      - name: Install PyTorch (Windows)
        if: runner.os == 'Windows'
        run: |
          pip install torch

      # ─────────────────────────────
      # Install Project
      # ─────────────────────────────
      - name: Install library
        run: |
          pip install .

      # ─────────────────────────────
      # Tests
      # ─────────────────────────────
      - name: Run tests
        run: |
          pytest tests/